# Byte Dashboard v1 - Product Vision & Architecture

**Last Updated:** February 6, 2026
**Status:** Active Development - Frontend Foundation Complete, Backend Pending

---

## Core Identity

**Byte Dashboard** is a **lightweight system for tracking people through multi-step processes**.

Initially built for government agencies (Fayette County Sheriff's Office) to manage job applicant tracking. Focused on delivering a working MVP, not promising configurability or general-purpose expansion yet.

### The Problem It Solves

Organizations need to:
- Ingest submissions from online forms (e.g., Formstack) and create workflow executions
- Track people through multi-stage review processes (background checks, interviews, approvals)
- Manage tasks associated with each workflow instance
- Handle documents/assets throughout the process
- Maintain visibility into pipeline status
- Support multiple organizations (multi-tenant)

### Primary Use Case

- **Job Application Process** (Sheriff's Office hiring)

### Potential Future Use Cases

Organizations may discover other uses (onboarding, grants, vendor management), but we're not selling configurability or general-purpose workflows yet. Let customers find those properties; don't promise them.

---

## V1 Philosophy: Radical Simplification

The previous codebase had **65 tables, 325 migrations, 252-file workflow builder**—an AI-generated prototype that spiraled into enterprise complexity.

**V1 is a complete reset** focusing on:
- **Simple over complex** - Hardcode things initially, add configurability later
- **JSONB for flexibility** - Custom fields, metadata, status configs in JSONB columns
- **Build what's needed** - Not what might be needed someday
- **9-11 tables instead of 65**

---

## Mental Model

```
Contact (person/entity)
    └── Workflow (instance of a process)
            ├── Tasks (steps to complete)
            └── Assets (documents, files)
```

**That's it.** Everything else is configuration or metadata.

---

## Data Model (10-11 Tables)

### Entity Relationship Overview

```
┌─────────────────┐
│     Clerk       │
│  Organizations  │
└────────┬────────┘
         │ org_id
         ▼
┌─────────────────┐      ┌──────────────────────┐
│     users       │      │ workflow_definitions │
│  (Clerk sync)   │      │   (blueprints)       │
└────────┬────────┘      └──────────┬───────────┘
         │                          │
         │ assigned_to              │ workflow_definition_id
         │                          │
         ▼                          ▼
┌─────────────────┐      ┌──────────────────────┐
│     tasks       │◄─────│ workflow_executions  │
└─────────────────┘      │    (instances)       │
                         └──────────┬───────────┘
                                    │
                                    │ contact_id
                                    ▼
                           ┌─────────────────┐
                           │    contacts     │
                           └─────────────────┘
```

### Core Tables

#### `users` (Clerk sync)
```sql
CREATE TABLE users (
  id            TEXT PRIMARY KEY,        -- Clerk user ID
  org_id        TEXT NOT NULL,           -- Clerk org ID
  email         TEXT NOT NULL,
  first_name    TEXT,
  last_name     TEXT,
  role          TEXT DEFAULT 'user',     -- DEPRECATED: use roles array
  roles         TEXT[] DEFAULT '{}',     -- NEW: Array of roles (admin, reviewer, hr, manager)
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_roles ON users USING GIN(roles);
```

#### `contacts`
```sql
CREATE TABLE contacts (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id          TEXT NOT NULL,
  first_name      TEXT NOT NULL,
  last_name       TEXT NOT NULL,
  email           TEXT,
  phone           TEXT,
  company         TEXT,
  role            TEXT,
  status          TEXT DEFAULT 'active' NOT NULL,  -- active, inactive, lead
  avatar_url      TEXT,
  last_contacted_at TIMESTAMPTZ,
  address_line_1  TEXT,
  address_line_2  TEXT,
  city            TEXT,
  state           TEXT,
  zip             TEXT,
  metadata        JSONB DEFAULT '{}',    -- custom fields
  tags            TEXT[] DEFAULT '{}',   -- simple array
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

#### `workflow_definitions`
```sql
CREATE TABLE workflow_definitions (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id      TEXT NOT NULL,
  name        TEXT NOT NULL,              -- "Job Application Process"
  description TEXT,
  version     INTEGER NOT NULL DEFAULT 1, -- Immutable versioning (edit = clone + increment)
  phases      JSONB DEFAULT '[]',         -- Array of phase definitions for visual grouping
  steps       JSONB NOT NULL DEFAULT '{"steps": []}',  -- Workflow step definitions
  variables   JSONB DEFAULT '{}',         -- Variable definitions
  statuses    JSONB NOT NULL DEFAULT '[]', -- Ordered array of status objects for UI
  is_active   BOOLEAN DEFAULT true,
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW()
);

-- Example phases JSONB:
-- [
--   {
--     "id": "phase_1",
--     "name": "Initial Review",
--     "description": "Review application and assign tasks",
--     "order": 1,
--     "step_ids": ["step_1", "step_2", "step_3"]
--   },
--   {
--     "id": "phase_2",
--     "name": "Background Check",
--     "order": 2,
--     "step_ids": ["step_4", "step_5"]
--   }
-- ]

-- Example statuses JSONB:
-- [
--   {"key": "submitted", "label": "Submitted", "color": "gray"},
--   {"key": "under_review", "label": "Under Review", "color": "blue"},
--   {"key": "background_check", "label": "Background Check", "color": "yellow"},
--   {"key": "interview", "label": "Interview", "color": "purple"},
--   {"key": "approved", "label": "Approved", "color": "green"},
--   {"key": "rejected", "label": "Rejected", "color": "red"}
-- ]
```

#### `workflow_executions` (instances of workflow definitions)
```sql
CREATE TABLE workflow_executions (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                  TEXT NOT NULL,
  workflow_definition_id  UUID REFERENCES workflow_definitions(id),
  definition_version      INTEGER,                       -- Frozen version at execution time
  contact_id              UUID NOT NULL REFERENCES contacts(id),
  current_step_id         TEXT,                           -- Which step is currently executing
  current_phase_id        TEXT,                           -- Track current phase for UI progress
  status                  TEXT NOT NULL DEFAULT 'running', -- Presentation-only (Temporal is authoritative)
  updated_by_temporal     BOOLEAN DEFAULT false,          -- Flag for constraint enforcement
  source                  TEXT DEFAULT 'manual',          -- manual, formstack, api
  source_id               TEXT,                           -- external reference ID
  started_at              TIMESTAMPTZ DEFAULT NOW(),
  completed_at            TIMESTAMPTZ,
  temporal_workflow_id    TEXT,                           -- Temporal workflow execution ID
  temporal_run_id         TEXT,                           -- Temporal run ID
  variables               JSONB DEFAULT '{}',            -- Runtime variables for this execution
  metadata                JSONB DEFAULT '{}',
  created_at              TIMESTAMPTZ DEFAULT NOW(),
  updated_at              TIMESTAMPTZ DEFAULT NOW()
);

-- Temporal workflow state is authoritative for progression
-- status is presentation-only (see Invariant 1 in FINALIZED_ARCHITECTURE.md)

CREATE INDEX idx_workflow_executions_org ON workflow_executions(org_id);
CREATE INDEX idx_workflow_executions_contact ON workflow_executions(contact_id);
CREATE INDEX idx_workflow_executions_status ON workflow_executions(org_id, status);
CREATE INDEX idx_workflow_executions_definition ON workflow_executions(workflow_definition_id);
CREATE INDEX idx_workflow_executions_temporal ON workflow_executions(temporal_workflow_id);
```

#### `tasks`
```sql
CREATE TABLE tasks (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                TEXT NOT NULL,
  workflow_execution_id UUID REFERENCES workflow_executions(id),
  contact_id            UUID REFERENCES contacts(id),
  assigned_to           TEXT REFERENCES users(id),      -- Specific user if claimed
  assigned_role         TEXT,                            -- Role if role-based assignment
  title                 TEXT NOT NULL,
  description           TEXT,
  task_type             TEXT DEFAULT 'standard',         -- standard, approval
  status                TEXT NOT NULL DEFAULT 'todo',    -- todo, in_progress, done
  priority              TEXT DEFAULT 'medium',           -- low, medium, high
  outcome               TEXT,                            -- approved, rejected, completed, etc.
  outcome_comment       TEXT,                            -- Comment from approver
  position              INTEGER DEFAULT 0,               -- For drag-and-drop ordering
  due_date              DATE,
  completed_at          TIMESTAMPTZ,
  created_by_step_id    TEXT,                            -- Which workflow step created this task
  metadata              JSONB DEFAULT '{}',
  created_at            TIMESTAMPTZ DEFAULT NOW(),
  updated_at            TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_tasks_org ON tasks(org_id);
CREATE INDEX idx_tasks_assigned ON tasks(assigned_to);
CREATE INDEX idx_tasks_role ON tasks(assigned_role) WHERE assigned_role IS NOT NULL;
CREATE INDEX idx_tasks_status ON tasks(org_id, status);
CREATE INDEX idx_tasks_workflow_execution ON tasks(workflow_execution_id);
CREATE INDEX idx_tasks_position ON tasks(org_id, status, position);
```

#### `assets` (NOT IN MVP - Placeholder Only)
```sql
-- NOT IMPLEMENTED IN MVP
-- Assets management deferred to v1.5
-- Nav placeholder exists but no functionality

-- Future v1.5 implementation will include:
-- - Upload/download endpoints
-- - Storage integration (Vercel Blob or R2)
-- - Preview/thumbnails
-- - Task attachments
-- - Quota tracking
```

#### `notes`
```sql
CREATE TABLE notes (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                TEXT NOT NULL,
  entity_type           TEXT NOT NULL,  -- 'workflow_execution', 'contact', 'task' (for rendering)
  entity_id             UUID NOT NULL,
  -- Soft FKs for sane queries (nullable, indexed)
  workflow_execution_id UUID REFERENCES workflow_executions(id) ON DELETE CASCADE,
  contact_id            UUID REFERENCES contacts(id) ON DELETE CASCADE,
  task_id               UUID REFERENCES tasks(id) ON DELETE CASCADE,
  user_id               TEXT NOT NULL REFERENCES users(id),
  content               TEXT NOT NULL,
  is_internal           BOOLEAN DEFAULT true,
  created_at            TIMESTAMPTZ DEFAULT NOW(),
  -- Ensure only one FK is set
  CONSTRAINT one_parent_only CHECK (
    (workflow_execution_id IS NOT NULL)::int +
    (contact_id IS NOT NULL)::int +
    (task_id IS NOT NULL)::int = 1
  )
);

CREATE INDEX idx_notes_entity ON notes(entity_type, entity_id);
CREATE INDEX idx_notes_org ON notes(org_id);
CREATE INDEX idx_notes_workflow_execution ON notes(workflow_execution_id) WHERE workflow_execution_id IS NOT NULL;
CREATE INDEX idx_notes_contact ON notes(contact_id) WHERE contact_id IS NOT NULL;
CREATE INDEX idx_notes_task ON notes(task_id) WHERE task_id IS NOT NULL;
```

#### `activity_log`
```sql
CREATE TABLE activity_log (
  id                    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id                TEXT NOT NULL,
  user_id               TEXT REFERENCES users(id),
  entity_type           TEXT NOT NULL,  -- 'workflow_execution', 'contact', 'task' (for rendering)
  entity_id             UUID NOT NULL,
  -- Soft FKs for sane queries (nullable, indexed)
  workflow_execution_id UUID REFERENCES workflow_executions(id) ON DELETE CASCADE,
  contact_id            UUID REFERENCES contacts(id) ON DELETE CASCADE,
  task_id               UUID REFERENCES tasks(id) ON DELETE CASCADE,
  action                TEXT NOT NULL,  -- 'created', 'updated', 'deleted', 'status_changed'
  details               JSONB DEFAULT '{}',
  created_at            TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_activity_org ON activity_log(org_id);
CREATE INDEX idx_activity_entity ON activity_log(entity_type, entity_id);
CREATE INDEX idx_activity_time ON activity_log(created_at DESC);
CREATE INDEX idx_activity_workflow_execution ON activity_log(workflow_execution_id) WHERE workflow_execution_id IS NOT NULL;
CREATE INDEX idx_activity_contact ON activity_log(contact_id) WHERE contact_id IS NOT NULL;
CREATE INDEX idx_activity_task ON activity_log(task_id) WHERE task_id IS NOT NULL;
```

#### `formstack_config`
```sql
CREATE TABLE formstack_config (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id          TEXT NOT NULL UNIQUE,
  webhook_secret  TEXT,
  field_mappings  JSONB DEFAULT '{}',  -- maps Formstack field IDs to our fields
  default_workflow_definition_id UUID REFERENCES workflow_definitions(id),
  is_active       BOOLEAN DEFAULT true,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  updated_at      TIMESTAMPTZ DEFAULT NOW()
);
```

#### `formstack_submissions`
```sql
CREATE TABLE formstack_submissions (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id          TEXT NOT NULL,
  form_id         TEXT NOT NULL,
  submission_id   TEXT NOT NULL,
  raw_payload     JSONB NOT NULL,
  processed       BOOLEAN DEFAULT false,
  workflow_execution_id UUID REFERENCES workflow_executions(id),
  error           TEXT,
  created_at      TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(org_id, submission_id)  -- Prevent duplicate webhook processing
);

CREATE INDEX idx_formstack_org ON formstack_submissions(org_id);
CREATE INDEX idx_formstack_processed ON formstack_submissions(processed) WHERE NOT processed;

-- Note: UNIQUE constraint prevents duplicate webhooks (Formstack retries on failure)
```

---

## Technical Stack

| Layer | Technology | Notes |
|-------|-----------|-------|
| Framework | Next.js 16.1.6 | App Router, React Server Components |
| React | 19.2.3 | Latest stable with Server Components |
| Language | TypeScript 5 | Strict mode |
| Auth | Clerk | Organizations for multi-tenant |
| Database | Neon PostgreSQL | Serverless Postgres (application data) |
| Workflow Engine | Temporal.io (Cloud) | Durable workflow orchestration (TypeScript SDK) |
| API/Backend | Next.js API Routes + Temporal Workers | Edge functions, workflow execution |
| ORM | Drizzle | TypeScript-first (not implemented yet) |
| Styling | Tailwind CSS 4 | CSS variables for theming |
| UI Components | shadcn/ui + Radix | Accessible primitives |
| State Management | TanStack Query | Server state (not implemented yet) |
| Forms | React Hook Form + Zod | Validation (not implemented yet) |
| File Storage | Vercel Blob | For v1, migrate to R2 later |
| Deployment | Vercel (frontend) + Temporal Cloud + Railway (workers) | Use Temporal Cloud for MVP (avoid ops overhead) |

---

## Workflow Architecture

**Byte Dashboard is a workflow automation platform** that orchestrates multi-step processes involving external integrations and long-running operations. Unlike simple CRUD apps, workflow executions can span hours, days, or weeks while waiting for external events.

### Why Temporal.io?

**The Problem:** Workflows involve:
- Multi-step processes triggered by external events (Formstack submissions)
- Operations that bounce between internal (DB) and external systems (email, forms, background checks)
- Async step-to-step progression with waits for external responses (days/weeks)
- Example: Application review → email hiring manager → **wait for task completion** → send background check form → **wait for submission** → call external API → schedule interview

**Why Not Simple API Routes?**
- API routes are stateless and can't "wait" for days
- No built-in retry logic or failure handling
- Can't survive server restarts mid-process
- No way to wait for external signals (form submissions, task completions)

**Temporal's Solution:**
- **Durable execution**: Workflows survive server restarts
- **Signal/wait patterns**: Can pause for external events (task completion, webhook, user action)
- **Automatic retries**: Configurable backoff and timeout handling
- **Long-running support**: Workflows can run for hours, days, or weeks
- **TypeScript SDK**: Full type safety, integrates with Next.js
- **Industry proven**: Used by Netflix, Stripe, Snap, Datadog

### How Workflows Work

```
External Event (Formstack webhook)
    ↓
API Route (app/api/webhooks/formstack)
    ↓
Start Temporal Workflow
    ↓
Workflow orchestrates:
    1. Activity: Create contact in DB (Drizzle)
    2. Activity: Create application in DB
    3. Activity: Send notification email
    4. Activity: Create review task
    5. Wait for Signal: task_completed
       ↓ (hours/days later)
    6. Activity: Send background check form
    7. Wait for Signal: form_submitted
       ↓ (days/weeks later)
    8. Activity: Call external API
    9. Activity: Update application status
    ↓
Workflow Complete
```

### Workflows vs. Activities

**Workflows** (in `lib/workflows/`)
- Orchestration logic only (what to do, in what order)
- Can wait for signals and timers
- Deterministic (no direct I/O)
- Example: `onboarding-workflow.ts`, `background-check.ts`

**Activities** (in `lib/activities/`)
- Actual work (database, API calls, emails)
- Non-deterministic operations
- Retryable
- Example: `database.ts`, `email.ts`, `integrations.ts`

### Integration Points

1. **Formstack Webhook** → API Route → Start Workflow
2. **Task Completion** (UI) → API Route → Signal Workflow
3. **Form Submission** (external) → Webhook → Signal Workflow
4. **Admin Actions** (UI) → API Route → Signal Workflow

### Workflow State Management

- **Business Data**: PostgreSQL (via Drizzle) - contacts, workflow_definitions, workflow_executions, tasks
- **Execution State**: Temporal's persistence layer - execution history, timers, signals
- **Workflow Definitions**: PostgreSQL - UI metadata (statuses, colors, labels) + step definitions

The `workflow_definitions` table stores UI configuration (status badges, colors, labels), while Temporal handles the actual execution, retries, and durability.

**Critical Invariant: UI Status ≠ Execution State**

The `workflow_executions.status` field is **presentation-only**. Temporal workflow state is authoritative.

**Rules:**
1. UI status changes must signal Temporal (not direct DB updates)
2. Status updates are derived from Temporal workflow outcomes
3. Never allow status dropdowns that bypass Temporal signals

**Example:**
```typescript
// ❌ WRONG: Direct status update
UPDATE workflow_executions SET status = 'approved' WHERE id = ?;

// ✅ CORRECT: Signal Temporal, workflow activity updates status
await temporalClient.workflow.signal(workflowId, 'approve', { reason: '...' });
// Temporal workflow activity updates workflow_executions.status as side effect
```

This prevents desyncing UI state from actual workflow progression.

---

## Frontend Structure (Current)

```
frontend/
├── app/                         # Next.js App Router
│   ├── (dashboard)/            # Route group with shared layout
│   │   ├── layout.tsx          # Sidebar + top navigation
│   │   ├── dashboard/          # Main dashboard view
│   │   ├── workflows/          # Workflow execution management
│   │   ├── people/             # Contact/people management
│   │   ├── tasks/              # Task management
│   │   ├── my-work/            # Personal work view
│   │   ├── calendar/           # Calendar view
│   │   ├── support/            # Support section
│   │   └── admin/              # Admin section
│   │       ├── settings/       # Settings with tab-based sub-navigation
│   │       │   ├── layout.tsx  # Shared tabs for all settings pages
│   │       │   ├── general/
│   │       │   ├── billing/
│   │       │   ├── users/
│   │       │   ├── integrations/
│   │       │   ├── audit/
│   │       │   ├── crm/
│   │       │   └── customizations/
│   │       └── workflow-blueprints/  # Manage workflow templates
│   ├── globals.css             # Tailwind v4 imports + CSS variables
│   └── layout.tsx              # Root layout with theme provider
├── components/
│   ├── ui/                     # shadcn/ui components (DO NOT edit)
│   ├── layout/                 # app-sidebar, page-header
│   ├── data-table/             # Reusable DataTable with TanStack Table
│   ├── workflows/              # Workflow-specific components
│   ├── contacts/               # Contact-specific components
│   ├── tasks/                  # Task-specific components
│   ├── assets/                 # Asset/document components (NEW)
│   ├── kanban/                 # Kanban board with dnd-kit
│   ├── dashboard/              # Dashboard widgets
│   ├── detail/                 # Detail page components
│   └── common/                 # Shared presentational components
├── lib/
│   ├── data/                   # Mock data for development
│   │   ├── workflows.ts        # Workflow execution mock data
│   │   ├── contacts.ts
│   │   ├── tasks.ts
│   │   ├── activity.ts
│   │   └── settings.ts
│   ├── db/                     # Database layer (Drizzle)
│   │   ├── index.ts            # DB connection
│   │   ├── schema.ts           # Drizzle schema
│   │   └── queries.ts          # Reusable queries
│   ├── workflows/              # Temporal workflows
│   │   ├── onboarding-workflow.ts
│   │   └── background-check.ts
│   ├── activities/             # Temporal activities
│   │   ├── database.ts         # DB operations
│   │   ├── email.ts            # Email sending
│   │   └── integrations.ts     # External API calls
│   ├── temporal/               # Temporal setup
│   │   ├── client.ts           # Temporal client
│   │   └── worker.ts           # Temporal worker
│   ├── validations/            # Zod schemas
│   ├── design-tokens.ts        # Semantic color mappings
│   ├── status-config.ts        # Badge variants for statuses/priorities
│   └── utils.ts                # Utility functions (cn, etc.)
├── types/
│   └── index.ts                # TypeScript types for all domain models
├── hooks/                      # Custom React hooks
└── middleware.ts               # Clerk authentication (DELETED - needs restoration)
```

---

## V1 Scope

### ✅ In Scope

#### 1. Foundation (✓ Complete)
- [x] Next.js 16 project initialized
- [x] Clerk authentication integrated
- [x] Basic role system (Admin, Member, Viewer)
- [x] Layout with sidebar navigation
- [x] Tailwind CSS v4 + shadcn/ui components
- [x] Theme switching (light/dark)
- [ ] Middleware for Clerk route protection (needs restoration)
- [ ] Temporal.io setup and configuration
- [ ] Temporal worker deployment
- [ ] Basic workflow orchestration patterns

#### 2. Contacts Module
- [ ] Contact list page (table with search/filter)
- [ ] Contact detail page
- [ ] Create contact form
- [ ] Edit contact
- [ ] Delete contact with confirmation

#### 3. Workflow Executions Module
- [ ] Workflow list page (table with filters)
- [ ] Workflow detail page
- [ ] Create workflow (manual)
- [ ] Edit workflow
- [ ] Status field with dropdown
- [ ] Link workflow to contact
- [ ] Simple status progression (config-based, not visual builder)

#### 4. Tasks & Kanban
- [ ] Task list page
- [ ] Create task form
- [ ] Assign task to user
- [ ] Due date picker
- [ ] Task status (todo, in_progress, done)
- [ ] Link task to workflow or contact
- [ ] Kanban board view
- [ ] Drag-and-drop between columns

#### 5. Assets/Documents (NOT IN MVP - Placeholder Only)
Assets management is fully deferred to v1.5+. No implementation in MVP.

**MVP:**
- [x] Nav placeholder exists (no functionality)
- **No** table, endpoints, storage, or UI in v1

#### 6. Dashboard
- [ ] Workflow count by status (pie/bar chart)
- [ ] Recent workflows list
- [ ] My tasks widget
- [ ] Workflows over time (line chart)
- [ ] Activity feed widget

#### 7. Calendar (NOT IN MVP - Placeholder Only)
Calendar view is deferred to v1.5+. No implementation in MVP.

**MVP:**
- [x] Nav placeholder exists (no functionality)
- **No** calendar component, views, or task integration in v1

#### 8. Settings
- [x] Settings page structure with tabs
- [ ] General settings (org info, preferences)
- [ ] User management (invite, edit, remove)
- [ ] Billing & plans (view/upgrade)
- [ ] Integrations (Formstack config)
- [ ] Audit logs (activity history)
- [ ] Workflow templates management

#### 9. Data & Exports
- [ ] CSV export for workflows
- [ ] CSV export for contacts
- [ ] Basic PDF report (workflow summary)

### ❌ Explicitly Out of Scope

Features deferred to v1.5+:

- **Formstack Integration (post-MVP)**: Webhook ingestion, field mapping, auto-triggered workflows
  - Build only when a customer specifically needs Formstack integration
- **Asset Management (v1.5)**: Complete asset system (storage, uploads, previews, thumbnails, metadata UI, quotas, task attachments)
  - **MVP has nav placeholder only - no functionality**
- **Calendar (v1.5)**: Calendar views, task scheduling, date-based filtering
  - **MVP has nav placeholder only - no functionality**
- Visual drag-and-drop workflow builder
- Dynamic form builder
- AI assistant (BYTE)
- Payment processing / Stripe integration
- Advanced document features (OCR, version control, e-signatures)
- Email notifications system
- Calendar integrations (Google/Outlook sync)
- Advanced integrations beyond Formstack
- Bulk import/export
- Custom fields UI (use JSONB for now)
- Advanced reporting / analytics
- Real-time collaboration
- Mobile app
- Production deployment optimization
- Comprehensive test coverage

---

## Success Criteria

MVP is complete when:

1. ✅ New org can sign up via Clerk
2. ✅ Users can build workflow definitions with linear step builder
3. ✅ Users can trigger and monitor workflow executions
4. ✅ Tasks can be created, assigned (user or role), and tracked via Kanban
5. ✅ Approval tasks work with approve/reject pattern
6. ✅ Dashboard shows pipeline overview
7. ✅ Data can be exported to CSV
8. ✅ All data is properly scoped to organization
9. ✅ No cross-tenant data leakage

---

## Implementation Roadmap

See **`context/MVP_ROADMAP.md`** for the detailed phased implementation plan with task tracking.

---

## Key Architecture Decisions

### 1. Temporal Workflows (Not Simple Status Sequences)

**Workflows are managed by Temporal**, not simple status transitions. The `workflow_definitions` table stores UI metadata (status labels, colors, badges for the frontend), while Temporal handles execution, retries, and durability.

**Example Workflow Code:**

```typescript
// lib/workflows/onboarding-workflow.ts
import { proxyActivities, defineSignal, setHandler, condition } from '@temporalio/workflow';
import type * as activities from '../activities';

const { createContact, createWorkflowExecution, sendEmail, createTask } = proxyActivities<typeof activities>({
  startToCloseTimeout: '5 minutes',
  retry: { maximumAttempts: 3 }
});

// Define signals for external events
const taskCompletedSignal = defineSignal<[string]>('taskCompleted');
const formSubmittedSignal = defineSignal<[object]>('formSubmitted');

export async function onboardingWorkflow(formData: FormstackSubmission) {
  // Step 1: Create contact and application
  const contact = await createContact(formData);
  const execution = await createWorkflowExecution(contact.id, formData);

  // Step 2: Send notification to hiring manager
  await sendEmail({
    to: 'hiring@example.com',
    template: 'new_application',
    data: { contact, application }
  });

  // Step 3: Create review task
  const reviewTask = await createTask({
    title: 'Review application',
    applicationId: application.id,
    assignedTo: 'hiring-manager-id'
  });

  // Step 4: Wait for task completion (could be hours/days)
  let taskId: string | undefined;
  setHandler(taskCompletedSignal, (id: string) => { taskId = id });
  await condition(() => taskId === reviewTask.id, '7 days'); // timeout after 7 days

  // Step 5: Send background check form
  await sendEmail({
    to: contact.email,
    template: 'background_check_form',
    data: { contact }
  });

  // Step 6: Wait for form submission (could be days/weeks)
  let formResponse: object | undefined;
  setHandler(formSubmittedSignal, (data: object) => { formResponse = data });
  await condition(() => formResponse !== undefined, '14 days');

  // Step 7: Process background check
  // ... more steps

  return { success: true, applicationId: application.id };
}
```

**Key Points:**
- **Durable**: Survives server restarts
- **Signal/Wait**: Can pause for external events (task completion, form submission)
- **Timeouts**: Configurable wait limits
- **Retries**: Automatic retry with backoff
- **UI Metadata**: `workflow_definitions` table still defines statuses for badges/filters in frontend

### 2. JSONB for Flexibility
- Custom fields on contacts: `metadata` JSONB column
- Workflow status definitions: `statuses` JSONB array
- Form field mappings: `field_mappings` JSONB object
- Activity details: `details` JSONB object

### 3. Clerk Handles Auth
- No custom auth tables
- Organizations = tenants
- Webhook syncs users to local table for app data
- Roles via Clerk's built-in system

### 4. One Tasks Table
Both workflow tasks AND manual tasks live in the same table:
- Workflow task: has `workflow_execution_id` and `created_by_step_id` fields
- Manual task: `workflow_execution_id` nullable, `task_type = 'standard'`

### 5. Assets Storage (post-MVP)
- V1: Vercel Blob (simple, integrated)
- Future: Cloudflare R2 (cheaper, unlimited egress)
- Storage quota tracked per organization

### 6. Polymorphic Relations with Soft FKs
`notes` and `activity_log` use hybrid approach:
- **entity_type + entity_id**: For flexible polymorphic rendering
- **Nullable FKs** (workflow_execution_id, contact_id, task_id): For sane queries, FK guarantees, indexed lookups
- **Constraint**: Ensures exactly one FK is set per row
- **Result**: Flexibility without N+1 queries or complex unions

Example query:
```sql
-- Get all activity for a workflow execution (fast, uses index)
SELECT * FROM activity_log WHERE workflow_execution_id = ?;

-- Get all activity for any entity (still works)
SELECT * FROM activity_log WHERE entity_type = 'workflow_execution' AND entity_id = ?;
```

---

## Development Guidelines

### Component Organization
- Use PascalCase for components
- Use camelCase for hooks (prefix with `use`)
- Route folders in kebab-case (`/my-work`, `/workflow-blueprints`)
- Co-locate entity-specific logic by domain

### Styling
- Use Tailwind utilities, maintain order: layout, spacing, color, state
- Theme all colors through CSS variables (defined in `globals.css`)
- Use semantic tokens from `lib/design-tokens.ts`
- Never hardcode color values

### Type Safety
- All types in `types/index.ts`
- Use `type` for unions/primitives
- Use `interface` for objects that may be extended
- Avoid `any` - lift types to shared location

### Import Paths
- Use `@/*` alias (resolves to `frontend/*`)
- Never use deep relative paths like `../../../components`

### Testing (Post-V1)
- Add React Testing Library or Vitest
- Co-locate tests: `Component.test.tsx`
- Integration tests in `app/__tests__/`

---

## Open Questions

To resolve before/during build:

1. **Existing data migration** - Any real data in old system that needs migration?
2. **Specific fields required** - Get final list of contact/workflow fields from FCSO
3. **Status workflow specifics** - Confirm the exact workflow statuses for their applicant tracking process
4. **User list** - Who needs accounts for initial pilot?
5. **Compliance requirements** - Any specific security certifications needed at launch?

---

## References

- **Old Codebase** - Use for domain knowledge, not implementation
  - Data model: `src/integrations/supabase/types.ts`
  - UI components: `src/components/ui/`
  - Business logic examples: `src/contexts/AuthContext.ts`
  - Formstack integration: `supabase/functions/formstack*/`

- **Documentation Files**
  - `CLAUDE.md` - Codebase and development instructions
  - `context/MVP_ROADMAP.md` - Implementation roadmap (single source of truth for phases)
  - `context/FINALIZED_ARCHITECTURE.md` - System architecture and invariants
  - `context/SCHEMA_BREAKDOWN.md` - Old vs new data model comparison
  - `context/byte reference/CODEBASE_AUDIT.md` - Why we're rebuilding
  - `context/byte reference/UI_ELEMENTS.md` - UI components reference

---

## Current Status (February 7, 2026)

### ✅ Complete
- Next.js 16 project scaffold with App Router
- Clerk authentication integrated
- Layout components (sidebar, header, settings tabs)
- shadcn/ui component library + Tailwind CSS v4
- Theme system (light/dark) with design tokens
- Neon PostgreSQL + Drizzle ORM schema (10 tables)
- Temporal.io setup with worker process
- Hardcoded applicant review workflow (validates architecture)
- Contacts CRUD (API routes + UI)
- Component consolidation (StatusFilter, FormDialog, GenericKanbanBoard, useDetailDialogEdit)

### ⏳ Current Phase
See `context/MVP_ROADMAP.md` for detailed progress tracking.

---

## Notes

- This is an MVP, not enterprise software
- Hardcode things initially, add configurability later
- Ship first, optimize later
- Focus on the core loop: Contact → Workflow Execution → Tasks
- Everything else is scope creep
